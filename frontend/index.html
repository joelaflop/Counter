<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
   <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'"> -->
   <meta http-equiv="X-Content-Security-Policy" content="default-src 'self'; script-src 'self'">
   <link href="app/css/main.css" rel="stylesheet" type="text/css" />
</head>

<body>
   <div class="container-fluid maincontainer bg-darkgray">
      <div class="maintable main-page">
         <div class="tablecell leftbar bg-black garamond-font pt-3 pl-2 pr-0">
            <nav class="navbar navbar-nav navbar-expand-lg navbar-dark px-0">
               <ul class="navbar-nav flex-column leftbarmovementfix">
                  <a class="navbar-brand pl-0" href="#">Counter</a>
                  <li class="nav-item">

                     <a id="recently played button" class="nav-link py-1 pl-1 pr-0" href="#">
                        <img src="app/img/icons/clock-history.svg" class="invert pb-1 pr-1" alt="" width="25"
                           height="25" title="Bootstrap">history</a>
                  </li>
                  <li class="nav-item">
                     <a id="user page button" class="nav-link py-1 pl-1 pr-0" href="#">
                        <img src="app/img/icons/person-square.svg" class="invert pb-1 pr-1" alt="" width="25"
                           height="25" title="Bootstrap">user</a>
                  </li>
                  <li class="nav-item">
                     <a id="data page button" class="nav-link pt-1 pb-0 pl-1 pr-0" href="#">
                        <img src="app/img/icons/clipboard-data.svg" class="invert pb-1 pr-1" alt="" width="25"
                           height="25" title="Bootstrap">data</a>
                     <div id="datadropdown" class="pl-4">
                        <a id="datatype1" class="nav-link py-0 pl-2 pr-0" href="#">type1</a>
                        <a id="datatype2" class="nav-link py-0 pl-2 pr-0" href="#">type2</a>
                     </div>
                  </li>
               </ul>
            </nav>
         </div>
         <div id="mainpage" class="tablecell avoidleftbar garamond-font">
            <div class="pagetitlebox bg-gray">
               <h4 class="pagetitle text-white">welcome</h4>
            </div>
         </div>
      </div>
      <nav class="navbar navbar-expand-lg bottombar fixed-bottom garamond-font bg-gray text-white pt-0 pl-0 ">
         <ul class="navbar-nav">
            <li class="nav-item leftbar pt-0 pl-3">
               <div id='nowplayingleftbar'>
               </div>
            </li>
            <li class="nav-item avoidleftbar">
               <div id="nowplaying"></div>
            </li>
         </ul>
      </nav>
   </div>

   <div>
      <div id="countsPage">
         <div class="pagetitlebox bg-gray">
            <h4 class="pagetitle text-white">history</h4>
         </div>
         <div id="recentlyplaying" class="mainpagedrop"></div>
      </div>

      <div id="userPage">
         <div class="pagetitlebox bg-gray">
            <h4 class="pagetitle text-white">user profile</h4>
         </div>
         <div id="usermainpage" class="mainpagedrop"></div>
      </div>

      <div id="dataPage">
         <div class="pagetitlebox bg-gray">
            <h4 class="pagetitle text-white">data insights</h4>
         </div>
         <div id="datamainpage" class="mainpagedrop"></div>
      </div>

      <div id='playingsomething'>
         <h4 class="nowtext">now</h4>
         <h4 class="playinngtext">playing</h4>
         <!-- <span class="navbar-brand pb-0 h1">now</span>
      <span class="navbar-brand pt-0 h1">playing</span> -->
      </div>
   </div>

   <!-- You can also require other files to run in this process -->
   <script src="app/js/mainRenderer.js"></script>
   <!-- <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script> -->
   <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
   <script src="./app/resources/Handlebars/track_object_full.precompiled.js"></script>
   <script src="./app/resources/Handlebars/user_object.precompiled.js"></script>
   <script src="./app/resources/Handlebars/recently_played_object_full.precompiled.js"></script>

   <script>

      var full_track_template = Handlebars.templates.track_object_full;
      ipcRenderer.on("auth-button-task-finished", function (event, arg) {
         console.log("renderer got confirmation of authbutton click")
      });
      ipcRenderer.on("nowplaying-button-task-finished", function (event, track) {
         console.log('got a nowplaying finish')
         if (track === "nothingplaying") {
            let nothingdiv = document.getElementById('nowplaying');
            nothingdiv.className = ' pl-3'
            nothingdiv.innerHTML = 'you\'re not playing anything'
            // document.getElementById('nowplayingleftbar').innerHTML = ''
         } else {
            document.getElementById('nowplaying').innerHTML = full_track_template(track)
            document.getElementById('nowplayingleftbar').innerHTML = document.getElementById('playingsomething').innerHTML
         }
      });
      var recently_played_track_template = Handlebars.templates.recently_played_object_full;
      ipcRenderer.on("recentlyplayed-button-task-finished", function (event, tracks) {
         parent = document.getElementById('recentlyplaying')
         parent.innerHTML = ""
         for (let i = 0; i < tracks.length; i++) {
            timestamp = handleTime(tracks[i].played_at)
            tracks[i].played_at = timestamp;
            child = document.createElement('div');
            child.className = "text-white";
            appendChild = parent.appendChild(child)
            appendChild.innerHTML = recently_played_track_template(tracks[i]);
            // console.log(1)
         }

         function handleTime (str) {
            let year = parseInt(str.substring(0, 4))
            let month = parseInt(str.substring(5, 7)) - 1
            let day = parseInt(str.substring(8, 10))
            let hour = parseInt(str.substring(11, 13))
            let min = parseInt(str.substring(14, 16))
            let sec = parseInt(str.substring(17, 19))
            let ms = parseInt(str.substring(20, 23))
            console.log(`listen: ${year}-${month}-${day} -- ${hour}:${min}:${sec}.${ms}`)
            var played_at = Date.UTC(year, month, day, hour, min, sec, ms)
            var now = Date.now();
            console.log(now)
            console.log(played_at)
            let min_passed = (now - played_at) / (1000 * 60);
            let res;
            if (min_passed < 1.5){
               res = `1 minute ago`
            }else if(min_passed < 60){
               min_passed = Math.round(min_passed)
               res = `${min_passed} minutes ago`
            } else if (min_passed < (60*24)){
               hours_passed = min_passed / 60;
               hours_passed = Math.round(hours_passed)
               if(hours_passed === 1){
                  res = `1 hour ago`
               } else {
                  res = `${hours_passed} hours ago`
               }
            } else if (min_passed < (60*24*2)) {
               res = `yesterday`
            } else {
               days_passed = min_passed / (60*24);
               days_passed = Math.round(days_passed)
               if(days_passed === 1){
                  res = `1 day ago`
               } else {
                  res = `${days_passed} days ago`
               }
            }
            return res;
         }
      });

   </script>

   <script>
      var user_template = Handlebars.templates.user_object;
      ipcRenderer.on("user-button-task-finished", function (event, user) {
         console.log('got a user page finish')
         console.log(user)
         document.getElementById('usermainpage').innerHTML = user_template(user)
      });
   </script>
</body>

</html>